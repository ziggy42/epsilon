/*
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/** Compile with:
```
emcc sorting.c -o sorting.wasm -s \
  EXPORTED_FUNCTIONS="['_bubble_sort', '_merge_sort', '_quick_sort']" \
  -s STANDALONE_WASM \
  -O3 \
  --no-entry
```
 */
#include <stdlib.h>
#include <string.h>

#define BUFFER_LENGTH 1000
static const int original_data[BUFFER_LENGTH] = {
    -98,  -977, 903,  -660, 264,  754,  284,  355,  898,  -935,  232,  872,
    -886, -547, 822,  513,  839,  -218, 443,  -500, -507, 558,   -514, -308,
    -919, 898,  782,  806,  486,  812,  -462, 763,  231,  982,   222,  408,
    -558, 556,  -753, -764, -78,  -675, -457, 479,  -109, -313,  63,   -260,
    -331, -736, 322,  -789, -844, -648, -352, 682,  632,  -389,  290,  91,
    -803, 164,  -73,  146,  222,  -756, -76,  -484, -673, 390,   397,  -75,
    953,  -593, -304, 793,  -168, 182,  -258, -628, -965, 470,   -87,  145,
    370,  -302, 572,  413,  557,  -708, -179, 882,  726,  -721,  63,   -783,
    -461, 625,  -432, -29,  -397, -319, -64,  972,  706,  -793,  -649, 134,
    -228, 321,  520,  231,  -92,  -776, 23,   -893, -475, -213,  639,  -614,
    -821, -352, -941, -482, 501,  509,  862,  -676, -240, 810,   403,  550,
    660,  -595, -727, -737, 529,  -11,  -434, 577,  -479, 173,   -778, 71,
    745,  -767, 292,  -532, -523, 380,  875,  669,  -647, -99,   -509, 58,
    272,  140,  -136, -20,  432,  -928, -388, 386,  -385, 392,   -36,  -957,
    -437, -504, -692, -620, 633,  -411, 842,  532,  -806, 206,   -663, 286,
    473,  397,  729,  -69,  306,  -261, -147, -534, 955,  735,   -380, -848,
    -667, -935, 632,  926,  -817, 276,  -632, 531,  518,  -975,  668,  654,
    397,  700,  -35,  -367, -963, -7,   -258, -993, 406,  238,   222,  956,
    -882, 406,  325,  -147, -726, -531, -691, -574, 423,  499,   250,  -7,
    661,  765,  382,  510,  -951, 600,  -590, 206,  133,  -418,  -638, -383,
    846,  115,  745,  383,  306,  998,  -935, 735,  -868, -109,  -745, -573,
    -24,  449,  885,  146,  -388, 68,   863,  -375, 28,   -577,  416,  -339,
    173,  745,  -581, 536,  -278, 794,  768,  -104, -943, -506,  452,  -21,
    -275, -954, 682,  926,  -519, -994, -739, -23,  -385, 74,    679,  -690,
    -321, 202,  -184, -953, -81,  78,   750,  31,   -680, -445,  -821, 646,
    417,  984,  -869, 685,  -481, -925, 459,  296,  803,  840,   -671, 910,
    -814, -344, 3,    -969, -10,  -824, 724,  586,  122,  -329,  -730, -742,
    -169, -964, 264,  -197, -284, 603,  37,   351,  -785, 567,   279,  790,
    891,  -366, 946,  47,   -151, 972,  42,   -550, -429, 991,   -870, -843,
    890,  -711, 680,  -349, 798,  609,  733,  -366, -687, 757,   69,   882,
    -973, -302, -417, -867, -566, 570,  39,   -121, -61,  -460,  629,  409,
    -703, 554,  506,  -305, -656, 919,  844,  861,  -601, 511,   -254, 300,
    625,  276,  -945, -798, -119, -436, -165, 648,  252,  -321,  -177, 422,
    -533, 30,   374,  513,  423,  -814, 251,  690,  -547, 34,    507,  101,
    -446, 847,  -665, 690,  -725, 104,  276,  324,  478,  -946,  -258, 538,
    -194, 883,  -830, -388, 333,  571,  914,  -627, 266,  -407,  62,   -849,
    -449, 179,  -302, 584,  -695, -264, -161, 458,  -244, 850,   360,  -392,
    318,  -753, 705,  265,  -188, -389, -870, -569, 810,  504,   -328, -420,
    938,  327,  -712, 487,  -394, -653, 378,  -722, 797,  -254,  -682, -855,
    734,  -590, -249, 21,   352,  800,  407,  -47,  -432, 432,   948,  134,
    -305, 928,  -854, 567,  -643, -320, -742, -312, -565, 604,   -811, 103,
    -908, -78,  213,  559,  638,  -46,  -713, 210,  336,  913,   644,  222,
    -842, -918, -128, 832,  -258, 679,  611,  -680, -802, 341,   938,  -624,
    -525, -611, -380, -739, 948,  -524, -54,  -911, 259,  -625,  357,  899,
    -961, 164,  46,   639,  736,  -719, 580,  -66,  -214, 795,   64,   -550,
    385,  -166, 84,   -95,  -21,  808,  -113, -175, 165,  -822,  -972, 711,
    -526, 304,  -164, 141,  940,  362,  -829, 764,  -579, 793,   -966, 244,
    170,  -615, -537, -14,  -603, 16,   -230, 89,   488,  -85,   623,  -580,
    156,  -534, 546,  111,  -720, -385, -816, -85,  -670, -863,  656,  216,
    -684, 177,  451,  27,   -963, 634,  439,  480,  -45,  -871,  -108, 676,
    -669, -370, 546,  15,   -813, -586, -697, -55,  870,  593,   -155, 718,
    513,  929,  675,  913,  52,   -586, 849,  -358, 549,  -831,  -322, 326,
    -171, 792,  -324, 59,   -217, 287,  703,  665,  161,  -578,  -843, -181,
    453,  -943, 350,  671,  -55,  351,  -354, -484, -427, 922,   -516, -423,
    697,  344,  -230, 608,  212,  969,  -25,  -645, 279,  -443,  71,   107,
    -359, -762, -681, -194, -998, -122, -150, -565, -216, -918,  -765, -417,
    668,  -168, -274, -6,   -459, -314, -97,  40,   -971, -488,  -546, 595,
    986,  -784, -837, -368, -604, -729, 582,  211,  -738, -472,  -584, -449,
    142,  172,  -684, 670,  774,  32,   125,  826,  -162, -773,  -217, 935,
    -212, 140,  993,  21,   527,  -444, 805,  752,  407,  908,   560,  -479,
    730,  -405, 709,  122,  -411, -412, 806,  -243, 575,  -875,  -328, -731,
    985,  705,  762,  370,  144,  155,  233,  852,  -200, 206,   -107, -894,
    193,  -895, -362, 532,  562,  -161, 765,  -306, -517, -1000, -273, 60,
    -350, 782,  -842, -309, -75,  -781, -705, -197, -319, 838,   817,  -65,
    69,   -384, 124,  304,  709,  704,  522,  806,  757,  960,   -394, -434,
    -256, 725,  -582, 62,   -815, -567, -808, -366, -191, 122,   224,  386,
    -928, -881, 179,  177,  -460, 149,  43,   343,  193,  367,   226,  511,
    -272, 729,  93,   59,   709,  -962, 388,  -982, 254,  -733,  616,  994,
    -281, 3,    -583, -437, -506, -333, 647,  -172, 996,  -979,  719,  463,
    -442, 949,  443,  -473, -436, 352,  -90,  -48,  -645, -519,  403,  449,
    660,  -303, -139, -563, -615, -555, -85,  -480, -270, 634,   -628, 386,
    -2,   -797, -799, -330, 117,  -893, -648, -968, -720, 443,   -664, 221,
    -798, -935, -439, -7,   -900, -264, -616, -616, -339, 558,   -448, 567,
    838,  -11,  105,  789,  -73,  -312, 49,   941,  -595, -967,  -827, -614,
    -39,  847,  973,  351,  -94,  930,  -898, 350,  -156, -912,  399,  -645,
    -119, -87,  299,  -405, 59,   -728, -63,  -76,  676,  790,   -372, -770,
    968,  -612, -505, 630,  963,  -839, -478, 828,  -166, 785,   970,  -383,
    -536, -513, 441,  805,  826,  61,   -458, -164, -19,  287,   -10,  -171,
    -973, -482, -929, -703, -40,  -782, -219, -342, 790,  -732,  3,    321,
    -675, -768, 647,  -973, -279, -322, -570, 318,  313,  -970,  -626, 169,
    -554, -466, -951, 871,  380,  452,  308,  -523, 924,  -215,  -940, -206,
    -617, 608,  570,  -782, -66,  557,  495,  374,  641,  323,   831,  283,
    38,   -891, -473, 846,  -711, -919, -777, -354, -638, -631,  85,   348,
    -185, 98,   -31,  340,
};

int data_buffer[BUFFER_LENGTH];

void init_data() { memcpy(data_buffer, original_data, sizeof(original_data)); }

void bubble_sort() {
  init_data();
  for (int i = 0; i < BUFFER_LENGTH; i++) {
    for (int j = 0; j < BUFFER_LENGTH - i - 1; j++) {
      if (data_buffer[j] > data_buffer[j + 1]) {
        int tmp = data_buffer[j + 1];
        data_buffer[j + 1] = data_buffer[j];
        data_buffer[j] = tmp;
      }
    }
  }
}

void merge_sort_internal(int *array, int left, int right) {
  if (left >= right) {
    return;
  }

  int mid = left + (right - left) / 2;
  merge_sort_internal(array, left, mid);
  merge_sort_internal(array, mid + 1, right);

  int n1 = mid - left + 1;
  int n2 = right - mid;
  int *left_array = (int *)malloc(n1 * sizeof(int));
  int *right_array = (int *)malloc(n2 * sizeof(int));
  for (int i = 0; i < n1; i++) {
    left_array[i] = array[left + i];
  }
  for (int j = 0; j < n2; j++) {
    right_array[j] = array[mid + 1 + j];
  }

  int i = 0;
  int j = 0;
  int k = left;
  while (i < n1 && j < n2) {
    if (left_array[i] <= right_array[j]) {
      array[k++] = left_array[i++];
    } else {
      array[k++] = right_array[j++];
    }
  }

  while (i < n1) {
    array[k++] = left_array[i++];
  }

  while (j < n2) {
    array[k++] = right_array[j++];
  }

  free(left_array);
  free(right_array);
}

void merge_sort() {
  init_data();
  merge_sort_internal(data_buffer, 0, BUFFER_LENGTH - 1);
}

void swap(int *a, int *b) {
  int temp = *a;
  *a = *b;
  *b = temp;
}

int partition(int *array, int left, int right) {
  int pivot = array[right];
  int i = left - 1;

  for (int j = left; j < right; j++) {
    if (array[j] <= pivot) {
      i++;
      swap(&array[i], &array[j]);
    }
  }
  swap(&array[i + 1], &array[right]);
  return i + 1;
}

void quick_sort_internal(int *array, int left, int right) {
  if (left >= right) {
    return;
  }
  int pivot_index = partition(array, left, right);
  quick_sort_internal(array, left, pivot_index - 1);
  quick_sort_internal(array, pivot_index + 1, right);
}

void quick_sort() {
  init_data();
  quick_sort_internal(data_buffer, 0, BUFFER_LENGTH - 1);
}
